#AWS 환경셋팅

1. AWS IAM계정 생성
 - https://aws.amazon.com/ko/ 페이지 우상단 [콘솔에 로그인] 클릭
 <img width="464" alt="스크린샷 2021-09-11 오전 11 27 39" src="https://user-images.githubusercontent.com/60597727/132933193-fe3a62d3-7e23-4484-8925-dba3355c2f38.png">
 - 계정 클릭 후 [내 보안 자격 증명] 클릭
 <img width="276" alt="스크린샷 2021-09-11 오전 11 32 30" src="https://user-images.githubusercontent.com/60597727/132933320-8e8e5d58-b339-4e6f-8039-bda5f5061646.png">
 - 좌측 [사용자] 메뉴 진입 후 우측 [사용자추가] 버튼 클릭
 <img width="1708" alt="스크린샷 2021-09-11 오전 11 36 57" src="https://user-images.githubusercontent.com/60597727/132933502-ac263a22-a015-42c6-93b0-5c52563f7d39.png">
 - 사용자이름 입력 및 [AWS Management Console 액세스] 체크
 <img width="977" alt="스크린샷 2021-09-11 오전 11 44 34" src="https://user-images.githubusercontent.com/60597727/132933613-e1045b79-27e9-49a8-a1ae-7e0f97c1af5d.png">


2. AWS 계정 정보 메모
 - account-id : 967638830673
 - 액세스 키 ID : AKIA6CS6EZZIRJXKARXD
 - 비번 : MY6jZQlLyL4sZtxr2WighnfonM1HrDOtWsjP+Dxd
 - 리전 : ap-northeast-2

3. AWS 설정
aws configure
AWS Access Key ID [****************USXH]: AKIA6CS6EZZIRJXKARXD
AWS Secret Access Key [****************LjHW]: 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
Default region name [ap-northeast-2]: ap-northeast-2
Default output format [json]: json


- AWS 클러스터 생성
eksctl create cluster --name (Cluster-Name) --version 1.17 --nodegroup-name standard-workers --node-type t3.medium --nodes 4 --nodes-min 1 --nodes-max 4

eksctl create cluster --name enyasio99-cluster --version 1.17 --nodegroup-name standard-workers --node-type t3.medium --nodes 4 --nodes-min 1 --nodes-max 4


- AWS 클러스터 토큰 가져오기
aws eks --region (Region-Code) update-kubeconfig --name (Cluster-Name)

aws eks --region ap-northeast-2 update-kubeconfig --name enyasio99-cluster

kubectl get all
kubectl config current-context


- AWS 컨테이너 레지스트리(ECR) 로그인
docker login --username AWS -p $(aws ecr get-login-password --region (Region-Code)) (Account-Id).dkr.ecr.(Region-Code).amazonaws.com/

docker login --username AWS -p $(aws ecr get-login-password --region ap-northeast-2) 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/


- AWS 컨테이너 레지스트리에 이미지 리파지토리 생성(마이크로 서비스 갯수별로 이미지명과 동일하게 생성)

aws ecr create-repository --repository-name (Image-Repository-Name) --image-scanning-configuration scanOnPush=true --region (Region-Code)

aws ecr create-repository --repository-name enyasio99-gateway --image-scanning-configuration scanOnPush=true --region ap-northeast-2

aws ecr create-repository --repository-name enyasio99-marketing --image-scanning-configuration scanOnPush=true --region ap-northeast-2

aws ecr create-repository --repository-name enyasio99-order --image-scanning-configuration scanOnPush=true --region ap-northeast-2

aws ecr create-repository --repository-name enyasio99-productdelivery --image-scanning-configuration scanOnPush=true --region ap-northeast-2


--프로젝트 소스 우분투 서버에 업로드 시켜야 함


--gateway

mvn package -B

docker build -t 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-gateway:v1 .  //계정/이미지명

docker push 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-gateway:v1

kubectl create deploy gateway --image=967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-gateway:v1

kubectl expose deployment gateway --type=LoadBalancer --port=8080


--marketing

mvn package -B

docker build -t 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-marketing:v1 .  //계정/이미지명

docker push 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-marketing:v1


--order

mvn package -B

docker build -t 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-order:v1 .  //계정/이미지명

docker push 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-order:v1


--productdelivery

mvn package -B

docker build -t 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-productdelivery:v1 .  //계정/이미지명

docker push 967638830673.dkr.ecr.ap-northeast-2.amazonaws.com/enyasio99-productdelivery:v1


—-프로젝트 루트로 이동

kubectl apply -f kubernetes/deployment.yml

kubectl apply -f kubernetes/service.yaml. —->요파일이 없네? ㅎ 어뜨케 작성하는거지?


--helm 으로 설치하기

curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3

chmod 700 get_helm.sh

./get_helm.sh


--카프카 설치

kubectl --namespace kube-system create sa tiller      # helm 의 설치관리자를 위한 시스템 사용자 생성

kubectl   create   clusterrolebinding   tiller   --clusterrole   cluster-admin   --serviceaccount=kube-
system:tiller

helm repo add incubator https://charts.helm.sh/incubator

helm repo update

kubectl create ns kafka

helm install my-kafka --namespace kafka incubator/kafka


--Siege 설치

kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: siege
spec:
  containers:
  - name: siege
    image: apexacme/siege-nginx
EOF
                         
